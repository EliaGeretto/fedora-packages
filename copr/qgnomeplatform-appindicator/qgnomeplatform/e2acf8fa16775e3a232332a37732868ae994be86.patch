From e2acf8fa16775e3a232332a37732868ae994be86 Mon Sep 17 00:00:00 2001
From: Jan Grulich <jgrulich@redhat.com>
Date: Mon, 23 Oct 2017 09:28:17 +0200
Subject: [PATCH] Add support for QDBusTrayIcon

---
 src/gnomehintssettings.h    |  5 +++--
 src/qgnomeplatformtheme.cpp | 24 ++++++++++++++++++++++--
 src/qgnomeplatformtheme.h   |  2 +-
 3 files changed, 26 insertions(+), 5 deletions(-)

diff --git a/src/gnomehintssettings.h b/src/gnomehintssettings.h
index 37c3bda..be144f0 100644
--- a/src/gnomehintssettings.h
+++ b/src/gnomehintssettings.h
@@ -26,9 +26,10 @@
 
 #undef signals
 #include <gio/gio.h>
-#include <qpa/qplatformtheme.h>
-
 #include <gtk-3.0/gtk/gtk.h>
+#define signals Q_SIGNALS
+
+#include <qpa/qplatformtheme.h>
 
 class QPalette;
 
diff --git a/src/qgnomeplatformtheme.cpp b/src/qgnomeplatformtheme.cpp
index d8210b3..65c29a0 100644
--- a/src/qgnomeplatformtheme.cpp
+++ b/src/qgnomeplatformtheme.cpp
@@ -24,6 +24,10 @@
 #include <QApplication>
 #include <QStyleFactory>
 
+#if !defined(QT_NO_DBUS) && !defined(QT_NO_SYSTEMTRAYICON)
+#include <private/qdbustrayicon_p.h>
+#endif
+
 QGnomePlatformTheme::QGnomePlatformTheme()
 {
     loadSettings();
@@ -95,10 +99,26 @@ QPlatformDialogHelper *QGnomePlatformTheme::createPlatformDialogHelper(QPlatform
     }
 }
 
-#ifndef QT_NO_SYSTEMTRAYICON
+#if !defined(QT_NO_DBUS) && !defined(QT_NO_SYSTEMTRAYICON)
+static bool isDBusTrayAvailable() {
+    static bool dbusTrayAvailable = false;
+    static bool dbusTrayAvailableKnown = false;
+    if (!dbusTrayAvailableKnown) {
+        QDBusMenuConnection conn;
+        if (conn.isStatusNotifierHostRegistered())
+            dbusTrayAvailable = true;
+        dbusTrayAvailableKnown = true;
+    }
+    return dbusTrayAvailable;
+}
+#endif
+
+#if !defined(QT_NO_DBUS) && !defined(QT_NO_SYSTEMTRAYICON)
 QPlatformSystemTrayIcon * QGnomePlatformTheme::createPlatformSystemTrayIcon() const
 {
-    return nullptr;
+    if (isDBusTrayAvailable())
+        return new QDBusTrayIcon();
+    return Q_NULLPTR;
 }
 #endif
 
diff --git a/src/qgnomeplatformtheme.h b/src/qgnomeplatformtheme.h
index 6f7d180..240df25 100644
--- a/src/qgnomeplatformtheme.h
+++ b/src/qgnomeplatformtheme.h
@@ -37,7 +37,7 @@ class QGnomePlatformTheme : public QPlatformTheme
     const QPalette *palette(Palette type = SystemPalette) const Q_DECL_OVERRIDE;
     bool usePlatformNativeDialog(DialogType type) const Q_DECL_OVERRIDE;
     QPlatformDialogHelper *createPlatformDialogHelper(DialogType type) const Q_DECL_OVERRIDE;
-#ifndef QT_NO_SYSTEMTRAYICON
+#if !defined(QT_NO_DBUS) && !defined(QT_NO_SYSTEMTRAYICON)
     virtual QPlatformSystemTrayIcon *createPlatformSystemTrayIcon() const;
 #endif
 
